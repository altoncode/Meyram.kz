<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meyram ‚Äî “ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑! –î–æ–º–µ–Ω-—Ç–µ—Å—Ç (20 —Å“±—Ä–∞“õ)</title>

  <!-- ‚úî –°–∞–ª—ã—Å—Ç—ã—Ä–º–∞–ª—ã –∂–æ–ª–¥–∞—Ä -->
  <link rel="icon" href="assets/img/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="assets/css/styles.css">

  <meta name="description" content="–ú–µ–π—Ä–∞–º –∫–∏–Ω–æ—Å—Ç—É–¥–∏—è—Å—ã: “õ—ã—Å“õ–∞—Ä—Ç—ã–ª“ì–∞–Ω –¥–æ–º–µ–Ω-—Ç–µ—Å—Ç (20 —Å“±—Ä–∞“õ). –°—Ç—Ä–∞—Ç–µ–≥–∏—è–ª—ã“õ –æ–π–ª–∞—É, “õ–∞—Ä—ã–º-“õ–∞—Ç—ã–Ω–∞—Å, –æ—Ä—ã–Ω–¥–∞—É, ”ô—Å–µ—Ä –µ—Ç—É –¥–æ–º–µ–Ω–¥–µ—Ä—ñ –±–æ–π—ã–Ω—à–∞ –Ω”ô—Ç–∏–∂–µ.">

  <!-- ‚úî –ñ–µ–¥–µ–ª override-—Ç–∞—Ä: –ª–æ–≥–æ ”©–ª—à–µ–º—ñ, –æ—Ä—Ç–∞–ª–∞—É, –∏–Ω–ø—É—Ç —Å—Ç–∏–ª—ñ -->
  <style>
    .header-row{display:flex;align-items:center;gap:12px}
    .logo{
      width:96px;height:96px;border-radius:20px;
      background:none !important;
      display:flex;align-items:center;justify-content:center;
    }
    .logo img{max-width:100%;max-height:100%;display:block}
    .centered{text-align:center}
    .tagline{ text-align:center; font-size:16px; line-height:1.5; color:var(--muted) }

    /* –ú–∞–º–∞–Ω ”©—Ä—ñ—Å—ñ */
    .field label{display:block;text-align:center;margin-bottom:10px;font-weight:600}
    .expert-input{
      width:100%;padding:12px 14px;border-radius:10px;
      border:1px solid rgba(255,255,255,.2);
      background:#fafafc;color:#0f0707;
      font-size:16px;font-weight:700;text-align:center; /* fixed */
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="screen-start">
      <div class="row" style="align-items:center;gap:12px;margin-bottom:10px">
        <div class="header-row">
          <div class="logo">
            <img src="assets/img/logo.png" alt="Meyram Logo">
          </div>
          <div>
            <div class="tagline">–ë–∞–ª–∞–ª–∞—Ä–¥—ã“£ —à—ã“ì–∞—Ä–º–∞—à—ã–ª—ã“ì—ã–Ω –∞—à–∞ –æ—Ç—ã—Ä—ã–ø, —Ç“±–ª“ì–∞ –±–æ–ª—É—ã–Ω–∞ “õ—ã–∑–º–µ—Ç –µ—Ç–µ–º—ñ–∑</div>
          </div>
        </div>
      </div>

      <h1 class="centered">
        –ú–µ–π—Ä–∞–º –∫–æ–º–ø–∞–Ω–∏—è—Å—ã–Ω–∞ “õ–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑! üé¨<br>
        “ö—ã—Å“õ–∞—Ä—Ç—ã–ª“ì–∞–Ω –¥–æ–º–µ–Ω-—Ç–µ—Å—Ç ‚Äî 20 —Å“±—Ä–∞“õ
      </h1>

      <p class="lead">–ë“±–ª —à–∞“ì—ã–Ω —Ç–µ—Å—Ç —Å—ñ–∑–¥—ñ“£ –∫“Ø—à—Ç—ñ –∂–∞“ì—ã“£—ã–∑–¥—ã –∞–Ω—ã“õ—Ç–∞—É“ì–∞ –∫”©–º–µ–∫—Ç–µ—Å–µ–¥—ñ. 4 –¥–æ–º–µ–Ω –±–æ–π—ã–Ω—à–∞ –Ω”ô—Ç–∏–∂–µ–Ω—ñ –±—ñ—Ä–¥–µ–Ω –∫”©—Ä—Å–µ—Ç–µ–º—ñ–∑: <strong>–ú—ã—à–ª–µ–Ω–∏–µ</strong>, <strong>–û—Ç–Ω–æ—à–µ–Ω–∏—è</strong>, <strong>–î–æ—Å—Ç–∏–≥–∞—Ç–æ—Ä—Å—Ç–≤–æ</strong>, <strong>–í–ª–∏—è–Ω–∏–µ</strong>.</p>

      <div class="row">
        <div class="grow">
          <div class="grid">
            <div class="pill">‚è± 20 —Å–µ–∫—É–Ω–¥—Ç—ã“õ —Ç–∞–π–º–µ—Ä –æ–ø—Ü–∏–æ–Ω–∞–ª</div>
            <label class="switch">
              <input type="checkbox" id="timerToggle" />
              <span class="toggle"></span>
              <span>–¢–∞–π–º–µ—Ä (20 —Å–µ–∫/—Å“±—Ä–∞“õ)</span>
            </label>
            <span class="muted">–ñ–∞—É–∞–ø—Ç–∞—Ä—ã“£—ã–∑ –∏–Ω—Ç—É–∏—Ç–∏–≤—Ç—ñ –±–æ–ª—É—ã “Ø—à—ñ–Ω —Ç–∞–π–º–µ—Ä–¥—ñ “õ–æ—Å–∞ –∞–ª–∞—Å—ã–∑. –¢–∞–π–º–µ—Ä “õ–æ—Å—É–ª—ã –±–æ–ª—Å–∞, —É–∞“õ—ã—Ç –±—ñ—Ç–∫–µ–Ω–¥–µ –∫–µ–ª–µ—Å—ñ —Å“±—Ä–∞“õ“õ–∞ –∞–≤—Ç–æ–º–∞—Ç—Ç—ã ”©—Ç–µ–¥—ñ.</span>
          </div>
        </div>
      </div>

      <div style="height:30px"></div>

      <!-- ‚úî –ú–∞–º–∞–Ω–Ω—ã“£ –∞—Ç—ã-–∂”©–Ω—ñ -->
      <div class="field">
        <label for="expertName">–ú–∞–º–∞–Ω–Ω—ã“£ –∞—Ç—ã-–∂”©–Ω—ñ:</label>
        <input
          type="text"
          id="expertName"
          class="expert-input"
          placeholder="–ê—Ç—ã“£—ã–∑–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑"
          autocomplete="name"
          autocapitalize="words"
        />
      </div>

      <div style="height:30px"></div>

      <button class="btn primary" id="btnStart">–¢–µ—Å—Ç—Ç—ñ –±–∞—Å—Ç–∞—É</button>
    </div>

    <div class="card hidden" id="screen-quiz">
      <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:8px">
        <div class="pill" id="qCounter" role="status" aria-live="polite" aria-atomic="true">üìã –°“±—Ä–∞“õ 1 / 20</div>
        <div class="pill" id="timerPill" style="display:none">‚è± <span id="timer" aria-live="polite" aria-atomic="true">20</span> —Å</div>
      </div>
      <div class="progress" aria-hidden="true"><div class="bar" id="progress"></div></div>
      <div style="height:16px"></div>
      <h2 id="qText" style="margin:0 0 8px"></h2>
      <p class="muted" id="qHint">–¢–∞“£–¥–∞“£—ã–∑: “õ–∞–Ω—à–∞–ª—ã“õ—Ç—ã —Å”ô–π–∫–µ—Å –∫–µ–ª–µ–¥—ñ?</p>
      <div class="scale" id="scale" role="radiogroup">
        <!-- options rendered by JS -->
      </div>
      <div class="row" style="margin-top:14px;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <button class="btn ghost" id="btnBack">‚Üê –ê–ª–¥—ã“£“ì—ã</button>
        <div class="row" style="gap:10px;flex:1">
          <button class="btn primary" id="btnNext">–ö–µ–ª–µ—Å—ñ ‚Üí</button>
        </div>
      </div>
    </div>

    <div class="card hidden" id="screen-result">
      <h1>–ù”ô—Ç–∏–∂–µ</h1>
      <!-- ‚úî –ú–∞–º–∞–Ω –∞—Ç—ã –Ω”ô—Ç–∏–∂–µ –±–µ—Ç—ñ–Ω–¥–µ -->
      <p id="expertDisplay" class="lead" style="margin-top:0"></p>

      <div class="result-grid">
        <div class="card inner">
          <h3 id="topTitle" style="margin-top:0"></h3>
          <p id="topDesc" class="tip"></p>
          <div class="bars" id="bars"></div>
        </div>
        <div class="card inner">
          <h3 style="margin-top:0">–¢“Ø—Å—ñ–Ω–¥—ñ—Ä–º–µ</h3>
          <div id="explain" class="grid"></div>
        </div>
      </div>
      <div class="row" style="margin-top:14px;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <button class="btn ghost" id="btnReview">–ñ–∞—É–∞–ø—Ç–∞—Ä–¥—ã “õ–∞—Ä–∞—É</button>
        <div class="row" style="gap:10px;flex:1">
          <button class="btn ghost" id="btnRestart">“ö–∞–π—Ç–∞ –±–∞—Å—Ç–∞—É</button>
          <button class="btn primary" id="btnExport">PDF —Ä–µ—Ç—ñ–Ω–¥–µ —Å–∞“õ—Ç–∞—É</button>
        </div>
      </div>
      <div class="footer">–ë“±–ª “õ—ã—Å“õ–∞—Ä—Ç—ã–ª“ì–∞–Ω —Å—ã–Ω–∞–º–∞ Gallup¬Æ —Ä–µ—Å–º–∏ —Ç–µ—Å—Ç—ñ–Ω –∞–ª–º–∞—Å—Ç—ã—Ä–º–∞–π–¥—ã. –ú–∞“õ—Å–∞—Ç—ã ‚Äî –¥–æ–º–µ–Ω-–±–∞“ì—ã—Ç—Ç—ã –±–æ–ª–∂–∞–º–¥—ã –∞–Ω—ã“õ—Ç–∞—É.</div>
    </div>
  </div>

  <!-- ‚úî –ù–µ–≥—ñ–∑–≥—ñ –ª–æ–≥–∏–∫–∞“£—ã–∑ -->
  <script src="assets/js/app.js" defer></script>

  <!-- ‚úî DOM->PDF –∫—ñ—Ç–∞–ø—Ö–∞–Ω–∞–ª–∞—Ä—ã -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- ‚úî PDF –≥–µ–Ω–µ—Ä–∞—Ü–∏—è + Google Drive –∂“Ø–∫—Ç–µ—É -->
  <script>
  (function(){
    'use strict';

    // ===== GAS –∫–æ–Ω—Ñ–∏–≥ (—Å—ñ–∑ –±–µ—Ä–≥–µ–Ω) =====
    const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzZUFbtDNt3XRiYEBIo8oFXIXn5-GeSiKo1YQZknvo81lYAi8deWO9ejfyUnI6mLp17/exec';
    const GAS_SECRET   = 'meyram_2025_Xx9hP7kL2qRv3sW8aJf1tZ4oBcDyGnHm';

    // ===== –ö”©–º–µ–∫—à—ñ–ª–µ—Ä =====
    function sanitizeFilename(name){
      return String(name || 'unknown')
        .trim()
        .replace(/[\/\\:\*\?"<>\|]+/g,'') // —Ç—ã–π—ã–º —Å–∞–ª—ã–Ω“ì–∞–Ω —Å–∏–º–≤–æ–ª–¥–∞—Ä
        .replace(/\s+/g,'_')              // –±–æ—Å –æ—Ä—ã–Ω ‚Üí _
        .slice(0,80);
    }
    function formatDateYMD(d=new Date()){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function blobToDataURL(blob){
      return new Promise((res,rej)=>{
        const r=new FileReader();
        r.onload = ()=>res(r.result);
        r.onerror = rej;
        r.readAsDataURL(blob);
      });
    }

    async function uploadPdfToDrive(pdfBlob, meta={}, filename){
      const dataURL = await blobToDataURL(pdfBlob);
      const payload = {
        filename: filename || `meyram-${Date.now()}.pdf`,
        mimeType: 'application/pdf',
        base64: dataURL,
        meta
      };
      const url = GAS_ENDPOINT + '?secret=' + encodeURIComponent(GAS_SECRET);
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // preflight –∂–æ“õ
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error('Drive upload failed: HTTP '+res.status);
      return res.json(); // { ok, fileUrl, name, ... }
    }

    async function makePdfFromDom(selector, options={}){
      const { margin = 10 } = options; // –º–º
      const el = document.querySelector(selector);
      if(!el) throw new Error('–ù”ô—Ç–∏–∂–µ DOM —Ç–∞–±—ã–ª–º–∞–¥—ã: '+selector);

      // –ù”ô—Ç–∏–∂–µ –∫–∞—Ä—Ç–∞—Å—ã–Ω –∞“õ —Ñ–æ–Ω–¥–∞ —Ä–µ–Ω–¥–µ—Ä–ª–µ—É
      const canvas = await html2canvas(el, { scale: 2, backgroundColor: '#ffffff' });
      const imgData = canvas.toDataURL('image/png');

      const pdf = new jspdf.jsPDF('p','mm','a4');
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const usableW = pageW - margin*2;

      const imgProps = pdf.getImageProperties(imgData);
      const imgW = usableW;
      const imgH = (imgProps.height * imgW) / imgProps.width;

      let x = margin, y = margin;
      pdf.addImage(imgData, 'PNG', x, y, imgW, imgH, undefined, 'FAST');

      // –ï–≥–µ—Ä –±–∏—ñ–∫—Ç—ñ–∫ –∫”©–ø –±–æ–ª—Å–∞ ‚Äî –±—ñ—Ä–Ω–µ—à–µ –±–µ—Ç–∫–µ "—Å—ã—Ä“ì—ã—Ç—ã–ø" –±–∞—Å–∞–º—ã–∑
      let position = y;
      while ((imgH + position) > pageH - margin) {
        position -= (pageH - margin*2);
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', x, position, imgW, imgH, undefined, 'FAST');
      }
      return pdf;
    }

    // –ú–∞–º–∞–Ω –∞—Ç—ã–Ω –∂–∞–¥—ã“ì–∞ “õ–æ—é (–µ–≥–µ—Ä app.js ”©–∑—ñ “õ–æ–π–º–∞—Å–∞)
    document.getElementById('btnStart')?.addEventListener('click', () => {
      const name = document.getElementById('expertName')?.value?.trim();
      if (name) {
        window.__who = window.__who || {};
        window.__who.name = name;
        const disp = document.getElementById('expertDisplay');
        if (disp && !disp.textContent.trim()) disp.textContent = '–ú–∞–º–∞–Ω: ' + name;
      }
    });

    // –ù–µ–≥—ñ–∑–≥—ñ —ç–∫—Å–ø–æ—Ä—Ç
    async function exportPDF(){
      // –ú–∞–º–∞–Ω –∞—Ç—ã–Ω –∞–ª—É: input ‚Üí window.__who ‚Üí —ç–∫—Ä–∞–Ω–¥–∞“ì—ã —Ç–µ–∫—Å—Ç ‚Üí 'unknown'
      let expert = document.getElementById('expertName')?.value?.trim()
                || (window.__who && window.__who.name)
                || document.getElementById('expertDisplay')?.textContent?.replace(/^–ú–∞–º–∞–Ω:\s*/,'')
                || 'unknown';
      expert = sanitizeFilename(expert);

      const fileName = `${expert}_${formatDateYMD(new Date())}.pdf`;

      const meta = {
        user: (window.__who && (window.__who.phone || window.__who.name)) || expert || 'anonymous',
        city: window.__who?.city || 'kz',
        score: window.__score || 0,
        quizId: 'meyram-quiz',
        generatedAt: new Date().toISOString()
      };

      // 1) PDF –∂–∞—Å–∞—É
      const pdf = await makePdfFromDom('#screen-result', { margin: 10 });

      // 2) –õ–æ–∫–∞–ª“ì–∞ —Å–∞“õ—Ç–∞—É
      pdf.save(fileName);

      // 3) Drive-“õ–∞ –¥”ô–ª —Å–æ–ª —Ñ–∞–π–ª–¥—ã –∂“Ø–∫—Ç–µ—É
      const pdfBlob = pdf.output('blob');
      try {
        const r = await uploadPdfToDrive(pdfBlob, meta, fileName);

        // –ë–∞—Ç—ã—Ä–º–∞–Ω—ã“£ –∂–∞–Ω—ã–Ω–∞ Drive —Å—ñ–ª—Ç–µ–º–µ—Å—ñ–Ω —à—ã“ì–∞—Ä—É
        let a = document.getElementById('drive-link');
        if (!a) {
          a = document.createElement('a');
          a.id = 'drive-link';
          a.target = '_blank';
          a.rel = 'noopener';
          a.style.marginLeft = '8px';
          const btnRow = document.getElementById('btnExport')?.parentElement;
          if (btnRow) btnRow.appendChild(a);
        }
        a.href = r.fileUrl;
        a.textContent = 'Drive: ' + (r.name || fileName);
        a.style.display = 'inline-block';

        alert('Drive-“õ–∞ —Å–∞“õ—Ç–∞–ª–¥—ã ‚úÖ');
      } catch (err) {
        console.error(err);
        alert('PDF –ª–æ–∫–∞–ª“ì–∞ —Å–∞“õ—Ç–∞–ª–¥—ã, –±—ñ—Ä–∞“õ Drive-“õ–∞ –∂“Ø–∫—Ç–µ—É —Å”ô—Ç—Å—ñ–∑. –ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.');
      }
    }

    // –ë–∞—Ç—ã—Ä–º–∞“ì–∞ —ñ–ª—É
    document.getElementById('btnExport')?.addEventListener('click', exportPDF);
  })();
  </script>
</body>
</html>
